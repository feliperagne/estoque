<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cadastramento e Listagem de Venda</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"
    ></script>

    <header th:include="fragmentos::topo"></header>
    <main>
      <h1 style="font-family: cursive">Cadastro da venda</h1>

      <div class="form-group">
        <label for="idCliente">Cliente Comprador:</label>
        <select class="form-control" id="idCliente">
          <option value="">Selecione um cliente:</option>
          <option
            th:each="item:${listacliente}"
            th:value="${item.id}"
            th:text="${item.nome}"
          ></option>
        </select>
      </div>

      <div class="form-group">
        <label for="idProduto">Produto:</label>
        <select class="form-control" id="idProduto">
          <option value="">Selecione um produto</option>
          <option
            th:each="item:${listaproduto}"
            th:value="${item.id}"
            th:text="${item.descricao}"
          ></option>
        </select>
      </div>

      <div style="margin: 20px" class="row">
        <div class="col-4">
          <input
            value="1"
            type="number"
            id="txtquantidade"
            class="form-control"
          />
        </div>
        <div class="col-4">
          <a id="btnincluirproduto" class="btn btn-primary" href="#">
            Incluir venda de produto
          </a>
        </div>
      </div>

      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">Código</th>
            <th scope="col">Descrição</th>
            <th scope="col">Quantidade</th>
            <th scope="col">Valor Unitário</th>
            <th scope="col">Total</th>
            <th scope="col">Alterar</th>
            <th scope="col">Excluir</th>
          </tr>
        </thead>
        <tbody id="dadosTabela"></tbody>
      </table>

      <table style="diplay: none">
        <tr id="linhaModelo">
          <td class="codigo"></td>
          <td class="descricao"></td>
          <td class="quantidade"></td>
          <select class="qntdproduto">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>
          <td class="valorunitario"></td>
          <td class="total"></td>
          <td class="totalinput">
            <input class="totalnumber" type="hidden" />
          </td>
          <td class="excluir">
            <a href="#" class="btnexcluir">Excluir</a>
          </td>
        </tr>
      </table>
      <h3>Total Geral <span id="totalgeral"></span></h3>
      <button id="btnsalvar">Salvar</button>
    </main>
    <footer th:include="fragmentos::rodape"></footer>

    <script type="text/javascript">
      $(document).ready(function () {
        $("#btnincluirproduto").click(function () {
          incluirProduto();
        });

        $("#btnsalvar").click(function () {
          finalizarVenda();
        });
      });

      function incluirProduto() {
        var linha = $("#linhamodelo").clone();
        linha.attr("id", "");

        $(linha).find(".codigo").text($("#idproduto").val());

        $(linha)
          .find(".descricao")
          .text($("#idproduto option:selected").text());

        $(linha).find(".quantidade").val($("#txtquantidade").val());

        //alterando a qtde do produto
        $(linha)
          .find(".quantidade")
          .change(function () {
            alterarProduto(linha);
          });

        $(linha)
          .find(".btnexcluir")
          .click(function () {
            excluirProduto(linha);
          });

        $("#dadostabela").append(linha);

        buscarProduto($("#idproduto").val(), linha);
      }

      function buscarProduto(id, linha) {
        $.get(
          "http://localhost:8080/produto/getProduto/" + id,
          function (resultado) {
            var qtde = $(linha).find(".quantidadeproduto").val();
            console.log(resultado);
            $(linha)
              .find(".total")
              .text(resultado.valor * qtde);
            $(linha).find(".quantidadeproduto").val($("txtquantidade").val());
            $(linha)
              .find(".quantidadeproduto")
              .change(function () {
                alterarProduto(linha);
              });
            $(linha)
              .find(".btnexcluir")
              .click(function () {
                excluirProduto(linha);
              });

            $("dadostabela").append(linha);
            buscarProduto($("#idproduto").val(), linha);
          }
        );
      }

      function alterarProduto(linha) {
        console.log(linha);
        var valorunitario = $(linha).find(".valorunitario").text();
        var qtde = $(linha).find(".quantidadeproduto").val();
        $(linha)
          .find(".total")
          .text(valorunitario * qtde);
        $(linha)
          .find(".totalnumber")
          .val(valorunitario * qtde);
        calcularTotal();
      }

      function calcularTotal() {
        var total = 0;

        $("#dadostabela").each(function (index, elemento) {
          var valor = $(elemento).find(".totalnumber").val();

          total = parseFloat(total) + parseFloat(valor);
        });

        $("#totalgeral").text(total);
      }

      function salvarProduto() {
        var produto = {
          id: $("#produto").val(),
          descricao: $("#produto").text(),
        };

        var model = {
          id: "null",
          produto: produto,
          qtde: $("#quantidade").val(),
        };

        $.ajax({
          type: "POST",
          url: "http://localhost:8080/venda/salvarProduto",
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify(model),
          dataType: "json",
          success: function (jsonResult) {
            console.log(jsonResult);
            var linhaclone = $("#linhaexemplo").clone();
            $(linhaclone).css("display", "block");
            $(linhaclone).find(".codigo").text(jsonResult.id);
            $(linhaclone).find(".descricao").text(jsonResult.descricao);
            $("#dadostabela").append(linhaclone);
          },
          failure: function (response) {
            alert("Erro ao carregar os dados: " + response);
          },
        });
      }

      function finalizarVenda() {
        // Obtenha os dados da venda, como o cliente comprador, produtos e quantidades selecionados
        var idCliente = $("#idCliente").val();
        var produtos = [];

        $("#dadosTabela tr").each(function () {
          var codigo = $(this).find(".codigo").text();
          var quantidade = $(this).find(".quantidade").val();

          produtos.push({
            codigo: codigo,
            quantidade: quantidade,
          });
        });

        // Crie um objeto com os dados da venda
        var venda = {
          idCliente: idCliente,
          produtos: produtos,
        };

        // Faça uma requisição AJAX para enviar os dados da venda para o backend
        $.ajax({
          type: "POST",
          url: "http://localhost:8080/venda/salvarProduto", // substitua pela URL correta do endpoint de criação de vendas
          contentType: "application/json",
          data: JSON.stringify(venda),
          success: function (response) {
            // Sucesso! Faça o que for necessário após finalizar a venda, como redirecionar para outra página ou exibir uma mensagem de sucesso.
            alert("Venda finalizada com sucesso!");
          },
          error: function (xhr, status, error) {
            // Ocorreu um erro ao finalizar a venda. Trate o erro adequadamente, exibindo uma mensagem de erro ou realizando outras ações necessárias.
            console.log("Erro ao finalizar a venda:", error);
          },
        });
      }
    </script>
  </body>
</html>
